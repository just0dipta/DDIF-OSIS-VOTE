<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Voting OSIS SMP Harapan 3 Delitua</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1a237e, #283593, #303f9f);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            color: #fff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .container {
            width: 100%;
            max-width: 1000px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            margin: 20px 0;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
        }

        .school-logo {
            width: 100px;
            height: 100px;
            margin: 0 auto 15px;
            background: #fff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .school-logo i {
            font-size: 50px;
            color: #1a237e;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: #4fc3f7;
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        h2 {
            font-size: 1.8rem;
            margin: 20px 0;
            color: #bb86fc;
        }

        h3 {
            font-size: 1.4rem;
            margin: 15px 0;
            color: #4fc3f7;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }

        input[type="password"],
        input[type="text"],
        input[type="number"],
        select {
            width: 100%;
            padding: 12px 15px;
            border: none;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.15);
            color: #fff;
            font-size: 16px;
            transition: all 0.3s;
        }

        input[type="password"]:focus,
        input[type="text"]:focus,
        input[type="number"]:focus,
        select:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.25);
            box-shadow: 0 0 0 2px #4fc3f7;
        }

        button {
            background: #2196f3;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            margin: 10px 5px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        button i {
            margin-right: 8px;
        }

        button:hover {
            background: #03a9f4;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        button:active {
            transform: translateY(0);
        }

        button.reset-btn {
            background: #f44336;
            padding: 8px 15px;
            font-size: 14px;
        }

        button.reset-btn:hover {
            background: #e53935;
        }

        button.delete-all-btn {
            background: #ff5722;
            margin-bottom: 20px;
        }

        button.delete-all-btn:hover {
            background: #e64a19;
        }

        .message {
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
            font-weight: 600;
        }

        .error {
            background: rgba(244, 67, 54, 0.3);
            color: #ffebee;
        }

        .success {
            background: rgba(76, 175, 80, 0.3);
            color: #e8f5e9;
        }

        .info {
            background: rgba(33, 150, 243, 0.3);
            color: #e3f2fd;
        }

        .hidden {
            display: none;
        }

        /* Navigation Tabs */
        .admin-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 12px 20px;
            color: rgba(255, 255, 255, 0.7);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }

        .tab-btn.active {
            color: #4fc3f7;
            border-bottom: 3px solid #4fc3f7;
        }

        .tab-btn:hover:not(.active) {
            color: #bb86fc;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #4fc3f7;
            margin: 10px 0;
        }

        /* Results */
        .result-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .progress-bar {
            height: 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            margin: 10px 0;
            overflow: hidden;
        }

        .progress {
            height: 100%;
            background: linear-gradient(90deg, #2196f3, #4fc3f7);
            border-radius: 10px;
            transition: width 0.5s;
        }

        /* User List */
        .user-list {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 10px;
        }

        .user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            margin-bottom: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            transition: all 0.3s;
        }

        .user-item:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateX(5px);
        }

        .user-info {
            flex: 1;
        }

        .user-name {
            font-weight: 600;
            color: #4fc3f7;
        }

        .user-status {
            font-size: 0.9rem;
            color: #bb86fc;
        }

        .voted {
            color: #4caf50;
        }

        .not-voted {
            color: #f44336;
        }

        /* Token Management */
        .token-form {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        .token-list {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 10px;
        }

        .token-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            margin-bottom: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            transition: all 0.3s;
        }

        .token-item:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateX(5px);
        }

        .token-info {
            flex: 1;
        }

        .token-value {
            font-weight: bold;
            font-family: monospace;
            font-size: 1.1rem;
            color: #4fc3f7;
        }

        .token-details {
            font-size: 0.9rem;
            color: #bb86fc;
            margin-top: 5px;
        }

        .token-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-right: 8px;
        }

        .status-active {
            background: rgba(76, 175, 80, 0.3);
            color: #e8f5e9;
        }

        .status-inactive {
            background: rgba(96, 125, 139, 0.3);
            color: #eceff1;
        }

        .status-expired {
            background: rgba(244, 67, 54, 0.3);
            color: #ffebee;
        }

        .status-used {
            background: rgba(255, 152, 0, 0.3);
            color: #fff3e0;
        }

        .token-actions {
            display: flex;
            gap: 8px;
        }

        .copy-btn {
            background: #9c27b0;
            padding: 8px 12px;
            font-size: 14px;
        }

        .copy-btn:hover {
            background: #8e24aa;
        }

        .toggle-btn {
            background: #ff9800;
            padding: 8px 12px;
            font-size: 14px;
        }

        .toggle-btn:hover {
            background: #f57c00;
        }

        .delete-btn {
            background: #f44336;
            padding: 8px 12px;
            font-size: 14px;
        }

        .delete-btn:hover {
            background: #e53935;
        }

        /* Popup Konfirmasi */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .popup-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .popup-content {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            transform: scale(0.9);
            transition: all 0.3s;
        }

        .popup-overlay.active .popup-content {
            transform: scale(1);
        }

        .popup-header {
            text-align: center;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .popup-icon {
            font-size: 2.5rem;
            color: #ff5722;
        }

        .popup-message {
            text-align: center;
            margin-bottom: 25px;
            line-height: 1.6;
        }

        .popup-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .popup-btn {
            min-width: 100px;
        }

        .popup-btn.cancel {
            background: #9e9e9e;
        }

        .popup-btn.cancel:hover {
            background: #757575;
        }

        .popup-btn.confirm {
            background: #f44336;
        }

        .popup-btn.confirm:hover {
            background: #e53935;
        }

        footer {
            text-align: center;
            margin-top: 40px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9rem;
        }

        .back-link {
            text-align: center;
            margin-top: 20px;
        }

        .back-link a {
            color: #4fc3f7;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s;
        }

        .back-link a:hover {
            color: #bb86fc;
            text-decoration: underline;
        }

        /* Responsive styles */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            h2 {
                font-size: 1.5rem;
            }
            
            .admin-tabs {
                flex-direction: column;
            }
            
            .tab-btn {
                width: 100%;
                text-align: center;
                border-bottom: none;
                border-left: 3px solid transparent;
            }
            
            .tab-btn.active {
                border-bottom: none;
                border-left: 3px solid #4fc3f7;
            }
            
            .user-item, .token-item {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .user-actions, .token-actions {
                margin-top: 10px;
                width: 100%;
                display: flex;
                justify-content: flex-end;
            }

            .form-row {
                flex-direction: column;
                gap: 10px;
            }

            .popup-content {
                padding: 20px;
            }

            .popup-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="school-logo">
                <i class="fas fa-graduation-cap"></i>
            </div>
            <h1>Panel Admin Voting OSIS</h1>
            <p>SMP Harapan 3 Delitua - Pemilihan Ketua OSIS Tahun Ajaran 2025/2026</p>
        </header>

        <div id="admin-login-section">
            <h2><i class="fas fa-lock"></i> Masuk sebagai Admin</h2>
            <div class="form-group">
                <label for="admin-password"><i class="fas fa-key"></i> Password Admin:</label>
                <input type="password" id="admin-password" placeholder="Masukkan password admin">
            </div>
            <button id="admin-login-btn"><i class="fas fa-sign-in-alt"></i> Masuk</button>
        </div>

        <div id="admin-section" class="hidden">
            <!-- Navigation Tabs -->
            <div class="admin-tabs">
                <button class="tab-btn active" data-tab="dashboard"><i class="fas fa-tachometer-alt"></i> Dashboard</button>
                <button class="tab-btn" data-tab="user-management"><i class="fas fa-users-cog"></i> Manajemen User</button>
                <button class="tab-btn" data-tab="token-management"><i class="fas fa-key"></i> Manajemen Token</button>
                <button id="live-admin-btn" onclick="window.location.href='live-admin.html'"><i class="fas fa-video"></i> Buka Live Admin</button>
            </div>

            <!-- Dashboard Tab -->
            <div id="dashboard-tab" class="tab-content active">
                <h2><i class="fas fa-tachometer-alt"></i> Dashboard</h2>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3><i class="fas fa-users"></i> Total Pemilih</h3>
                        <div class="stat-number" id="total-voters">3</div>
                        <p>Jumlah siswa yang terdaftar</p>
                    </div>
                    <div class="stat-card">
                        <h3><i class="fas fa-vote-yea"></i> Sudah Voting</h3>
                        <div class="stat-number" id="voted-count">0</div>
                        <p>Pemilih yang sudah memberikan suara</p>
                    </div>
                    <div class="stat-card">
                        <h3><i class="fas fa-clock"></i> Belum Voting</h3>
                        <div class="stat-number" id="not-voted-count">3</div>
                        <p>Pemilih yang belum memberikan suara</p>
                    </div>
                </div>
                
                <h3><i class="fas fa-chart-bar"></i> Hasil Voting</h3>
                <div id="results-container">
                    <p class="message info">Belum ada hasil voting.</p>
                </div>
                
                <h3><i class="fas fa-cog"></i> Administrasi Sistem</h3>
                <div class="result-item">
                    <p>Reset status voting semua pemilih (akan mengatur ulang semua data voting)</p>
                    <button id="reset-votes" class="reset"><i class="fas fa-trash-alt"></i> Reset Semua Voting</button>
                    <p class="last-updated" id="last-updated">Terakhir diperbarui: -</p>
                </div>
            </div>

            <!-- User Management Tab -->
            <div id="user-management-tab" class="tab-content">
                <h2><i class="fas fa-users-cog"></i> Manajemen User</h2>
                
                <!-- Tombol Hapus Semua Data -->
                <div style="text-align: center; margin-bottom: 25px;">
                    <button id="delete-all-btn" class="delete-all-btn">
                        <i class="fas fa-trash"></i> Hapus Semua Data Voting
                    </button>
                    <p style="font-size: 0.9rem; margin-top: 5px; color: #bb86fc;">
                        Perhatian: Tindakan ini akan menghapus semua data voting dan tidak dapat dibatalkan!
                    </p>
                </div>
                
                <div class="search-section">
                    <div class="form-group">
                        <label for="search-user"><i class="fas fa-search"></i> Cari User:</label>
                        <input type="text" id="search-user" placeholder="Masukkan nama user">
                    </div>
                </div>
                
                <h3><i class="fas fa-list"></i> Daftar Semua User</h3>
                <div class="user-list" id="user-list">
                    <!-- Data user akan dimuat di sini -->
                </div>
            </div>

            <!-- Token Management Tab -->
            <div id="token-management-tab" class="tab-content">
                <h2><i class="fas fa-key"></i> Manajemen Token OTP</h2>
                
                <div class="token-form">
                    <h3><i class="fas fa-plus-circle"></i> Generate Token Baru</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="token-type">Tipe Token:</label>
                            <select id="token-type">
                                <option value="single">Single Use (1x Pakai)</option>
                                <option value="multi">Multi Use (Banyak Pakai)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="token-validity">Masa Berlaku (jam):</label>
                            <input type="number" id="token-validity" min="1" max="24" value="1" placeholder="1-24 jam">
                        </div>
                    </div>
                    <button id="generate-token-btn"><i class="fas fa-key"></i> Generate Token</button>
                </div>
                
                <h3><i class="fas fa-list"></i> Daftar Token</h3>
                <div class="token-list" id="token-list">
                    <!-- Daftar token akan dimuat di sini -->
                </div>
            </div>
            
            <button id="admin-logout-btn"><i class="fas fa-sign-out-alt"></i> Logout Admin</button>
        </div>

        <div class="back-link">
            <a href="index.html"><i class="fas fa-arrow-left"></i> Kembali ke Halaman Voting</a>
        </div>
    </div>

    <!-- Popup Konfirmasi -->
    <div class="popup-overlay" id="confirmation-popup">
        <div class="popup-content">
            <div class="popup-header">
                <i class="fas fa-exclamation-triangle popup-icon"></i>
                <h3>Konfirmasi Tindakan</h3>
            </div>
            <div class="popup-message" id="popup-message">
                Apakah Anda yakin ingin melakukan tindakan ini?
            </div>
            <div class="popup-buttons">
                <button class="popup-btn cancel" id="popup-cancel">Batal</button>
                <button class="popup-btn confirm" id="popup-confirm">Ya, Lanjutkan</button>
            </div>
        </div>
    </div>

    <footer>
        <p>Â© 2025 Panel Admin Voting OSIS - Dilt dev</p>
    </footer>

    <script>
        // Konfigurasi Firebase
        const firebaseConfig = {
          apiKey: "AIzaSyAOKl1IV8cGfHhpSPXidFX2x060PYkLafA",
          authDomain: "hartig-project.firebaseapp.com",
          databaseURL: "https://hartig-project-default-rtdb.asia-southeast1.firebasedatabase.app",
          projectId: "hartig-project",
          storageBucket: "hartig-project.firebasestorage.app",
          messagingSenderId: "584839002596",
          appId: "1:584839002596:web:5d99bb50508daec8db6ff1"
        };
        
        // Inisialisasi Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Contoh data siswa (3 contoh saja)
        const students = {
            "7A01": { name: "Abimanyoe Aryo Halim", class: "7A" },
            "7A02": { name: "Affan Jailani Haehap", class: "7A" },
            "7A03": { name: "Afiqah Ayudia Nimeesya Nasution", class: "7A" }
        };

        // Elemen DOM
        const adminLoginSection = document.getElementById('admin-login-section');
        const adminSection = document.getElementById('admin-section');
        const adminPasswordInput = document.getElementById('admin-password');
        const adminLoginBtn = document.getElementById('admin-login-btn');
        const adminLogoutBtn = document.getElementById('admin-logout-btn');
        const resetVotesBtn = document.getElementById('reset-votes');
        const deleteAllBtn = document.getElementById('delete-all-btn');
        const searchUserInput = document.getElementById('search-user');
        const userListEl = document.getElementById('user-list');
        const generateTokenBtn = document.getElementById('generate-token-btn');
        const tokenTypeSelect = document.getElementById('token-type');
        const tokenValidityInput = document.getElementById('token-validity');
        const tokenListEl = document.getElementById('token-list');
        const totalVotersEl = document.getElementById('total-voters');
        const votedCountEl = document.getElementById('voted-count');
        const notVotedCountEl = document.getElementById('not-voted-count');
        const resultsContainer = document.getElementById('results-container');
        const lastUpdatedEl = document.getElementById('last-updated');
        
        // Tab elements
        const tabBtns = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');
        
        // Popup elements
        const confirmationPopup = document.getElementById('confirmation-popup');
        const popupMessage = document.getElementById('popup-message');
        const popupCancel = document.getElementById('popup-cancel');
        const popupConfirm = document.getElementById('popup-confirm');
        
        // Password admin
        const adminPassword = "admin123";
        
        // Variabel untuk menyimpan konteks konfirmasi
        let confirmAction = null;
        let confirmParams = null;

        // Event Listeners
        adminLoginBtn.addEventListener('click', adminLogin);
        adminLogoutBtn.addEventListener('click', adminLogout);
        resetVotesBtn.addEventListener('click', () => {
            showConfirmation(
                "Reset Semua Voting",
                "Apakah Anda yakin ingin mereset SEMUA data voting? Tindakan ini akan mengatur ulang semua status voting.",
                resetAllVotes
            );
        });
        deleteAllBtn.addEventListener('click', () => {
            showConfirmation(
                "Hapus Semua Data Voting",
                "Apakah Anda yakin ingin menghapus SEMUA data voting? Tindakan ini akan menghapus semua status voting dan tidak dapat dibatalkan!",
                deleteAllVotes
            );
        });
        searchUserInput.addEventListener('input', filterUsers);
        generateTokenBtn.addEventListener('click', generateToken);
        
        // Tab navigation
        tabBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const tabId = btn.getAttribute('data-tab');
                
                // Remove active class from all tabs and contents
                tabBtns.forEach(b => b.classList.remove('active'));
                tabContents.forEach(c => c.classList.remove('active'));
                
                // Add active class to clicked tab and corresponding content
                btn.classList.add('active');
                document.getElementById(`${tabId}-tab`).classList.add('active');
                
                // Load data if needed
                if (tabId === 'user-management') {
                    loadUsersData();
                } else if (tabId === 'token-management') {
                    loadTokensData();
                }
            });
        });
        
        // Event listeners untuk popup
        popupCancel.addEventListener('click', hideConfirmation);
        popupConfirm.addEventListener('click', executeConfirmedAction);

        // Fungsi untuk menampilkan popup konfirmasi
        function showConfirmation(title, message, action, params = null) {
            document.querySelector('.popup-header h3').textContent = title;
            popupMessage.textContent = message;
            confirmAction = action;
            confirmParams = params;
            confirmationPopup.classList.add('active');
        }

        // Fungsi untuk menyembunyikan popup konfirmasi
        function hideConfirmation() {
            confirmationPopup.classList.remove('active');
            confirmAction = null;
            confirmParams = null;
        }

        // Fungsi untuk menjalankan aksi yang dikonfirmasi
        function executeConfirmedAction() {
            if (confirmAction) {
                if (confirmParams) {
                    confirmAction(confirmParams);
                } else {
                    confirmAction();
                }
            }
            hideConfirmation();
        }

        // Fungsi untuk login admin
        function adminLogin() {
            const password = adminPasswordInput.value.trim();
            
            if (password === adminPassword) {
                adminLoginSection.classList.add('hidden');
                adminSection.classList.remove('hidden');
                loadDashboardData();
                setupRealtimeListeners();
            } else {
                showMessage('error', 'Password admin salah!');
            }
        }

        // Fungsi untuk logout admin
        function adminLogout() {
            adminSection.classList.add('hidden');
            adminLoginSection.classList.remove('hidden');
            adminPasswordInput.value = '';
        }

        // Setup realtime listeners untuk data yang berubah
        function setupRealtimeListeners() {
            // Listen untuk perubahan data voters
            database.ref('voters').on('value', function(snapshot) {
                const votersData = snapshot.val() || {};
                updateDashboardStats(votersData);
                updateUserList(votersData);
            });
            
            // Listen untuk perubahan data candidates
            database.ref('candidates').on('value', function(snapshot) {
                const candidatesData = snapshot.val() || {};
                updateResults(candidatesData);
            });
            
            // Listen untuk perubahan data tokens
            database.ref('tokens').on('value', function(snapshot) {
                if (document.getElementById('token-management-tab').classList.contains('active')) {
                    const tokensData = snapshot.val() || {};
                    displayTokens(tokensData);
                }
            });
        }

        // Fungsi untuk memuat data dashboard
        function loadDashboardData() {
            // Ambil data pemilih dan kandidat
            Promise.all([
                database.ref('voters').once('value'),
                database.ref('candidates').once('value')
            ]).then(([votersSnapshot, candidatesSnapshot]) => {
                const votersData = votersSnapshot.val() || {};
                const candidatesData = candidatesSnapshot.val() || {};
                
                updateDashboardStats(votersData);
                updateResults(candidatesData);
                updateLastUpdated();
            }).catch(error => {
                showMessage('error', 'Gagal memuat data: ' + error.message);
            });
        }

        // Update statistik dashboard
        function updateDashboardStats(votersData) {
            const totalVoters = Object.keys(students).length;
            const votedCount = Object.values(votersData).filter(voter => voter && voter.hasVoted).length;
            const notVotedCount = totalVoters - votedCount;
            const votePercentage = totalVoters > 0 ? (votedCount / totalVoters * 100).toFixed(1) : 0;
            
            totalVotersEl.textContent = totalVoters;
            votedCountEl.textContent = `${votedCount} (${votePercentage}%)`;
            notVotedCountEl.textContent = notVotedCount;
        }

        // Update hasil voting
        function updateResults(candidatesData) {
            resultsContainer.innerHTML = '';
            
            if (!candidatesData) {
                resultsContainer.innerHTML = '<p class="message info">Belum ada hasil voting.</p>';
                return;
            }
            
            // Hitung total votes
            let totalVotes = 0;
            Object.values(candidatesData).forEach(candidate => {
                totalVotes += candidate.votes || 0;
            });
            
            if (totalVotes === 0) {
                resultsContainer.innerHTML = '<p class="message info">Belum ada hasil voting.</p>';
                return;
            }
            
            // Urutkan kandidat berdasarkan jumlah vote
            const sortedCandidates = Object.entries(candidatesData).sort((a, b) => {
                return (b[1].votes || 0) - (a[1].votes || 0);
            });
            
            sortedCandidates.forEach(([id, candidate], index) => {
                const percentage = totalVotes > 0 ? ((candidate.votes || 0) / totalVotes * 100).toFixed(1) : 0;
                
                const resultItem = document.createElement('div');
                resultItem.className = 'result-item';
                
                if (index === 0 && candidate.votes > 0) {
                    resultItem.innerHTML = `<span class="winner-badge"><i class="fas fa-trophy"></i> PEMENANG</span>`;
                }
                
                resultItem.innerHTML += `
                    <h3>${candidate.name || 'Kandidat ' + id}</h3>
                    <p>${candidate.votes || 0} suara (${percentage}%)</p>
                    <div class="progress-bar">
                        <div class="progress" style="width: ${percentage}%"></div>
                    </div>
                `;
                
                resultsContainer.appendChild(resultItem);
            });
        }

        // Fungsi untuk memuat data user
        function loadUsersData() {
            userListEl.innerHTML = '<p class="message info">Memuat data user...</p>';
            
            // Ambil data voters dari Firebase
            database.ref('voters').once('value')
                .then(snapshot => {
                    const votersData = snapshot.val() || {};
                    displayUsers(votersData);
                })
                .catch(error => {
                    showMessage('error', 'Gagal memuat data user: ' + error.message);
                });
        }

        // Update daftar user
        function updateUserList(votersData) {
            if (document.getElementById('user-management-tab').classList.contains('active')) {
                displayUsers(votersData);
            }
        }

        // Fungsi untuk menampilkan daftar user
        function displayUsers(votersData) {
            userListEl.innerHTML = '';
            
            if (Object.keys(students).length === 0) {
                userListEl.innerHTML = '<p class="message info">Tidak ada data user.</p>';
                return;
            }
            
            Object.entries(students).forEach(([studentId, studentInfo]) => {
                const hasVoted = votersData[studentId] && votersData[studentId].hasVoted;
                const votedFor = votersData[studentId] && votersData[studentId].votedFor;
                const timestamp = votersData[studentId] && votersData[studentId].timestamp;
                
                const userItem = document.createElement('div');
                userItem.className = 'user-item';
                userItem.dataset.studentId = studentId;
                
                userItem.innerHTML = `
                    <div class="user-info">
                        <div class="user-name">${studentInfo.name} (${studentId})</div>
                        <div class="user-status ${hasVoted ? 'voted' : 'not-voted'}">
                            <i class="fas ${hasVoted ? 'fa-check-circle' : 'fa-times-circle'}"></i>
                            ${hasVoted ? 'Sudah voting' : 'Belum voting'}
                            ${hasVoted && votedFor ? ` (Kandidat ${votedFor})` : ''}
                        </div>
                        ${timestamp ? `<div class="user-timestamp">Waktu: ${new Date(timestamp).toLocaleString('id-ID')}</div>` : ''}
                    </div>
                    <div class="user-actions">
                        ${hasVoted ? `
                            <button class="reset-btn" data-student-id="${studentId}">
                                <i class="fas fa-undo"></i> Reset Status
                            </button>
                        ` : '<span class="user-status">Tidak perlu reset</span>'}
                    </div>
                `;
                
                userListEl.appendChild(userItem);
            });
            
            // Tambahkan event listener untuk tombol reset
            document.querySelectorAll('.reset-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const studentId = this.getAttribute('data-student-id');
                    showConfirmation(
                        "Reset Status Voting",
                        `Apakah Anda yakin ingin mereset status voting untuk ${studentId}?`,
                        resetUserVote,
                        studentId
                    );
                });
            });
        }

        // Fungsi untuk filter user berdasarkan pencarian
        function filterUsers() {
            const searchTerm = searchUserInput.value.trim().toLowerCase();
            const userItems = document.querySelectorAll('.user-item');
            
            userItems.forEach(item => {
                const studentId = item.dataset.studentId.toLowerCase();
                const studentName = item.querySelector('.user-name').textContent.toLowerCase();
                
                if (studentId.includes(searchTerm) || studentName.includes(searchTerm)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // Fungsi untuk generate token baru
        function generateToken() {
            const tokenType = tokenTypeSelect.value;
            const validityHours = parseInt(tokenValidityInput.value) || 1;
            
            if (validityHours < 1 || validityHours > 24) {
                showMessage('error', 'Masa berlaku token harus antara 1-24 jam!');
                return;
            }
            
            // Generate random token (6 karakter alfanumerik)
            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let token = '';
            for (let i = 0; i < 6; i++) {
                token += characters.charAt(Math.floor(Math.random() * characters.length));
            }
            
            // Hitung waktu expired
            const createdAt = new Date().toISOString();
            const expiredAt = new Date(Date.now() + validityHours * 60 * 60 * 1000).toISOString();
            
            // Simpan token ke Firebase
            database.ref('tokens/' + token).set({
                token: token,
                type: tokenType,
                active: true,
                createdAt: createdAt,
                expiredAt: expiredAt,
                used: false,
                usedBy: null,
                usedAt: null
            })
            .then(() => {
                showMessage('success', `Token ${token} berhasil dibuat! Berlaku hingga ${new Date(expiredAt).toLocaleString('id-ID')}`);
                copyToClipboard(token);
            })
            .catch(error => {
                showMessage('error', 'Gagal membuat token: ' + error.message);
            });
        }

        // Fungsi untuk memuat data token
        function loadTokensData() {
            tokenListEl.innerHTML = '<p class="message info">Memuat data token...</p>';
            
            database.ref('tokens').once('value')
                .then(snapshot => {
                    const tokensData = snapshot.val() || {};
                    displayTokens(tokensData);
                })
                .catch(error => {
                    showMessage('error', 'Gagal memuat data token: ' + error.message);
                });
        }

        // Fungsi untuk menampilkan daftar token
        function displayTokens(tokensData) {
            tokenListEl.innerHTML = '';
            
            if (Object.keys(tokensData).length === 0) {
                tokenListEl.innerHTML = '<p class="message info">Belum ada token yang dibuat.</p>';
                return;
            }
            
            // Urutkan token berdasarkan waktu dibuat (terbaru pertama)
            const sortedTokens = Object.entries(tokensData).sort((a, b) => {
                return new Date(b[1].createdAt) - new Date(a[1].createdAt);
            });
            
            sortedTokens.forEach(([token, tokenData]) => {
                const isExpired = new Date() > new Date(tokenData.expiredAt);
                const isUsed = tokenData.used;
                const isActive = tokenData.active && !isExpired && !isUsed;
                
                let status = 'active';
                let statusText = 'Aktif';
                
                if (isUsed) {
                    status = 'used';
                    statusText = 'Terpakai';
                } else if (isExpired) {
                    status = 'expired';
                    statusText = 'Kadaluarsa';
                } else if (!tokenData.active) {
                    status = 'inactive';
                    statusText = 'Nonaktif';
                }
                
                const tokenItem = document.createElement('div');
                tokenItem.className = 'token-item';
                
                tokenItem.innerHTML = `
                    <div class="token-info">
                        <div class="token-value">${token}</div>
                        <div class="token-details">
                            <span class="token-status status-${status}">${statusText}</span>
                            Tipe: ${tokenData.type === 'single' ? 'Single Use' : 'Multi Use'}
                            | Dibuat: ${new Date(tokenData.createdAt).toLocaleString('id-ID')}
                            | Expired: ${new Date(tokenData.expiredAt).toLocaleString('id-ID')}
                            ${tokenData.usedBy ? `| Digunakan oleh: ${tokenData.usedBy}` : ''}
                        </div>
                    </div>
                    <div class="token-actions">
                        <button class="copy-btn" data-token="${token}">
                            <i class="fas fa-copy"></i> Salin
                        </button>
                        <button class="toggle-btn" data-token="${token}" data-active="${tokenData.active}">
                            <i class="fas ${tokenData.active ? 'fa-toggle-on' : 'fa-toggle-off'}"></i> ${tokenData.active ? 'Nonaktifkan' : 'Aktifkan'}
                        </button>
                        <button class="delete-btn" data-token="${token}">
                            <i class="fas fa-trash"></i> Hapus
                        </button>
                    </div>
                `;
                
                tokenListEl.appendChild(tokenItem);
            });
            
            // Tambahkan event listener untuk tombol
            document.querySelectorAll('.copy-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const token = this.getAttribute('data-token');
                    copyToClipboard(token);
                    showMessage('success', 'Token berhasil disalin!');
                });
            });
            
            document.querySelectorAll('.toggle-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const token = this.getAttribute('data-token');
                    const isActive = this.getAttribute('data-active') === 'true';
                    
                    database.ref('tokens/' + token).update({
                        active: !isActive
                    })
                    .then(() => {
                        showMessage('success', `Token ${token} berhasil ${!isActive ? 'diaktifkan' : 'dinonaktifkan'}!`);
                    })
                    .catch(error => {
                        showMessage('error', 'Gagal mengubah status token: ' + error.message);
                    });
                });
            });
            
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const token = this.getAttribute('data-token');
                    
                    showConfirmation(
                        "Hapus Token",
                        `Apakah Anda yakin ingin menghapus token ${token}?`,
                        deleteToken,
                        token
                    );
                });
            });
        }

        // Fungsi untuk menghapus token
        function deleteToken(token) {
            database.ref('tokens/' + token).remove()
                .then(() => {
                    showMessage('success', `Token ${token} berhasil dihapus!`);
                })
                .catch(error => {
                    showMessage('error', 'Gagal menghapus token: ' + error.message);
                });
        }

        // Fungsi untuk menyalin teks ke clipboard
        function copyToClipboard(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
        }

        // Fungsi untuk reset status voting user
        function resetUserVote(studentId) {
            // Dapatkan data kandidat yang dipilih user sebelumnya
            database.ref('voters/' + studentId).once('value')
                .then(snapshot => {
                    const userData = snapshot.val();
                    const previousVote = userData && userData.votedFor;
                    
                    // Reset status voting user
                    const updates = {};
                    updates['voters/' + studentId + '/hasVoted'] = false;
                    updates['voters/' + studentId + '/votedFor'] = null;
                    updates['voters/' + studentId + '/timestamp'] = null;
                    
                    // Kurangi vote dari kandidat sebelumnya jika ada
                    if (previousVote) {
                        database.ref('candidates/' + previousVote + '/votes').transaction(currentVotes => {
                            return (currentVotes || 1) - 1;
                        });
                        
                        // Hapus user dari daftar voters kandidat
                        updates['candidates/' + previousVote + '/voters/' + studentId] = null;
                    }
                    
                    // Terapkan semua update
                    database.ref().update(updates)
                        .then(() => {
                            showMessage('success', `Status voting untuk ${studentId} berhasil direset!`);
                        })
                        .catch(error => {
                            showMessage('error', 'Gagal mereset status voting: ' + error.message);
                        });
                })
                .catch(error => {
                    showMessage('error', 'Gagal mengambil data user: ' + error.message);
                });
        }

        // Fungsi untuk reset semua voting
        function resetAllVotes() {
            // Reset semua status voting
            const updates = {};
            Object.keys(students).forEach(studentId => {
                updates['voters/' + studentId + '/hasVoted'] = false;
                updates['voters/' + studentId + '/votedFor'] = null;
                updates['voters/' + studentId + '/timestamp'] = null;
            });
            
            // Reset jumlah vote kandidat
            for (let i = 1; i <= 5; i++) {
                updates['candidates/' + i + '/votes'] = 0;
                updates['candidates/' + i + '/voters'] = {};
            }
            
            database.ref().update(updates)
                .then(() => {
                    showMessage('success', 'Semua status voting berhasil direset!');
                    updateLastUpdated();
                })
                .catch(error => {
                    showMessage('error', 'Gagal mereset status voting: ' + error.message);
                });
        }

        // Fungsi untuk menghapus semua data voting
        function deleteAllVotes() {
            // Hapus semua data voters
            database.ref('voters').remove()
                .then(() => {
                    // Reset jumlah vote kandidat
                    const updates = {};
                    for (let i = 1; i <= 5; i++) {
                        updates['candidates/' + i + '/votes'] = 0;
                        updates['candidates/' + i + '/voters'] = {};
                    }
                    
                    return database.ref().update(updates);
                })
                .then(() => {
                    showMessage('success', 'Semua data voting berhasil dihapus!');
                    updateLastUpdated();
                })
                .catch(error => {
                    showMessage('error', 'Gagal menghapus data voting: ' + error.message);
                });
        }

        // Update waktu terakhir diperbarui
        function updateLastUpdated() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('id-ID');
            const dateString = now.toLocaleDateString('id-ID', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            lastUpdatedEl.textContent = `Terakhir diperbarui: ${dateString} pukul ${timeString}`;
        }

        // Fungsi untuk menampilkan pesan
        function showMessage(type, text) {
            // Hapus pesan sebelumnya
            const existingMessages = document.querySelectorAll('.message');
            existingMessages.forEach(msg => msg.remove());
            
            // Buat pesan baru
            const message = document.createElement('div');
            message.className = `message ${type}`;
            message.innerHTML = `<i class="fas fa-${type === 'error' ? 'exclamation-circle' : type === 'success' ? 'check-circle' : 'info-circle'}"></i> ${text}`;
            
            // Tambahkan pesan ke bagian admin
            adminSection.appendChild(message);
            
            // Hapus pesan setelah 5 detik
            setTimeout(() => {
                message.remove();
            }, 5000);
        }
    </script>
</body>
</html>
